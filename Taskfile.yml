version: '3'

dotenv: ['.env']

tasks:
  default:
    cmds:
      - task --list

  collect:
    desc: Collect top Spotify songs by popularity
    vars:
      OUTPUT: '{{default "collect.json" .OUTPUT}}'
      START: '{{default "1970" .START}}'
      END: '{{default "2025" .END}}'
    cmds:
      - go run cmd/collect/main.go -output {{.OUTPUT}} -start {{.START}} -end {{.END}}

  lookup:
    desc: Lookup and fix links for collected songs
    vars:
      INPUT: '{{default "collect.json" .INPUT}}'
      SUMMARY: '{{default "lookup.json" .SUMMARY}}'
      START: '{{default "1970" .START}}'
      END: '{{default "2025" .END}}'
    cmds:
      - go run cmd/lookup/*.go -input {{.INPUT}} -summary {{.SUMMARY}} -start {{.START}} -end {{.END}}

  generate:
    desc: Generate card assets from looked up songs
    vars:
      INPUT: '{{default "lookup.json" .INPUT}}'
      OUTPUT: '{{default "generated" .OUTPUT}}'
    cmds:
      - go run cmd/generate/*.go -input {{.INPUT}} -output {{.OUTPUT}}

  web:
    desc: Serve the web app
    vars:
      PORT: '{{default "8000" .PORT}}'
    cmds:
      - npx tsc web/app.ts --target es2020
      - DEV_MODE=true python3 web/serve_https.py {{.PORT}}

  docker:build:
    desc: Build the Docker image for the web app
    cmds:
      - docker build -t temporalize-web .

  docker:publish:
    desc: Publish the Docker image to jbaldwin's docker registry
    deps: [docker:build]
    cmds:
      - docker tag temporalize-web:latest docker-registry.service:30000/temporalize:latest
      - docker push docker-registry.service:30000/temporalize:latest